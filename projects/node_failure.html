
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Fault-tolerance with PFASST: node failures &#8212; pySDC 2 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Fast-Wave-Slow-Wave SDC" href="fwsw.html" />
    <link rel="prev" title="Attempts to parallelize SDC" href="parallelSDC.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="fwsw.html" title="Fast-Wave-Slow-Wave SDC"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="parallelSDC.html" title="Attempts to parallelize SDC"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pySDC 2 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="fault-tolerance-with-pfasst-node-failures">
<h1>Fault-tolerance with PFASST: node failures<a class="headerlink" href="#fault-tolerance-with-pfasst-node-failures" title="Permalink to this headline">¶</a></h1>
<p>In this project, we explore PFASST’s potential to deal with node failures.
We derive different strategies which allow PFASST to continue after one time-step has failed.
Failure injectation as well as the different strategies are contained in <code class="docutils literal notranslate"><span class="pre">emulate_hard_faults</span></code> and the modified controller <code class="docutils literal notranslate"><span class="pre">allinclusive_classic_nonMPI_hard_faults</span></code> allows faults to appear before a fine sweep.
We test our ideas for two simple toy problems and two more complex show cases.
This project contains the code for the publication <a class="reference external" href="https://arxiv.org/abs/1510.08334">Toward fault-tolerant parallel-in-time integration with PFASST</a> of pySDC v2,
while the original code can be found under <a class="reference external" href="https://doi.org/10.5281/zenodo.32765">pySDC: Fault-tolerant PFASST</a>.
Note that due to the long runtime, the results are not generated via Travis. Only the visualization (and therefore the existence of the data files) is tested.</p>
<div class="section" id="propagation-of-a-single-node-failure">
<h2>Propagation of a single node failure<a class="headerlink" href="#propagation-of-a-single-node-failure" title="Permalink to this headline">¶</a></h2>
<p>We start by analyzing the propagation and containment of a single fault at step 7, iteration 7, see <code class="docutils literal notranslate"><span class="pre">hard_faults_detail</span></code>.
We do this for the heat and advection equation, both in 1D.
Four different strategies are tested:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">SPREAD</span></code>: a simple restart from scratch, i.e. the node/time-step is restarted by copying u0 to all quadrature nodes</li>
<li><code class="docutils literal notranslate"><span class="pre">SPREAD_PREDICT</span></code>: in addition to copying u0, we also do multiple SDC sweeps on the coarse level</li>
<li><code class="docutils literal notranslate"><span class="pre">INTERP</span></code>: instead of copying u0, we interpolate the values at the quadrature nodes by taking the next and the following time-step into account</li>
<li><code class="docutils literal notranslate"><span class="pre">INTERP_PREDICT</span></code>: in addition to interpolation, we also do coarse SDC sweeps</li>
</ul>
<p>The results are plotted using <code class="docutils literal notranslate"><span class="pre">postproc_hard_faults_detail</span></code>.</p>
<p>Full code: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/projects/node_failure/hard_faults_detail.py">pySDC/projects/node_failure/hard_faults_detail.py</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pySDC.implementations.problem_classes.HeatEquation_1D_FD_forced</span> <span class="k">import</span> <span class="n">heat1d_forced</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.problem_classes.AdvectionEquation_1D_FD</span> <span class="k">import</span> <span class="n">advection1d</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.transfer_classes.TransferMesh</span> <span class="k">import</span> <span class="n">mesh_to_mesh</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.datatype_classes.mesh</span> <span class="k">import</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">rhs_imex_mesh</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.imex_1st_order</span> <span class="k">import</span> <span class="n">imex_1st_order</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.generic_implicit</span> <span class="k">import</span> <span class="n">generic_implicit</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.collocation_classes.gauss_radau_right</span> <span class="k">import</span> <span class="n">CollGaussRadau_Right</span>

<span class="kn">from</span> <span class="nn">pySDC.helpers.stats_helper</span> <span class="k">import</span> <span class="n">filter_stats</span><span class="p">,</span> <span class="n">sort_stats</span>

<span class="kn">from</span> <span class="nn">pySDC.projects.node_failure.allinclusive_classic_nonMPI_hard_faults</span> <span class="k">import</span> <span class="n">allinclusive_classic_nonMPI_hard_faults</span>
<span class="kn">import</span> <span class="nn">pySDC.projects.node_failure.emulate_hard_faults</span> <span class="k">as</span> <span class="nn">ft</span>


<span class="c1"># noinspection PyShadowingNames,PyShadowingBuiltins</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">ft_setups</span><span class="p">,</span> <span class="n">ft_strategies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This routine generates the heatmaps showing the residual for a node failures at step n and iteration k</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num_procs</span> <span class="o">=</span> <span class="mi">16</span>

    <span class="c1"># initialize level parameters</span>
    <span class="n">level_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-09</span>

    <span class="c1"># initialize step parameters</span>
    <span class="n">step_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">step_params</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="c1"># initialize space transfer parameters</span>
    <span class="n">space_transfer_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;finter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;rorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;iorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>

    <span class="c1"># initialize sweeper parameters</span>
    <span class="n">sweeper_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;collocation_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CollGaussRadau_Right</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># initialize controller parameters</span>
    <span class="n">controller_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;logger_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="c1"># choose the iteration/step where the fault should happen</span>
    <span class="n">ft_step</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">ft_iter</span> <span class="o">=</span> <span class="mi">7</span>

    <span class="k">for</span> <span class="n">setup</span> <span class="ow">in</span> <span class="n">ft_setups</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">setup</span> <span class="ow">is</span> <span class="s1">&#39;HEAT&#39;</span><span class="p">:</span>

            <span class="c1"># initialize problem parameters</span>
            <span class="n">problem_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">]</span>

            <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

            <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;periodic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># fill description dictionary for easy step instantiation</span>
            <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">heat1d_forced</span>  <span class="c1"># pass problem class</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>  <span class="c1"># pass problem parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span>  <span class="c1"># pass data type for u</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs_imex_mesh</span>  <span class="c1"># pass data type for f</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imex_1st_order</span>  <span class="c1"># pass sweeper (see part B)</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>  <span class="c1"># pass sweeper parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>  <span class="c1"># pass level parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>  <span class="c1"># pass step parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_to_mesh</span>  <span class="c1"># pass spatial transfer class</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">space_transfer_params</span>  <span class="c1"># pass paramters for spatial transfer</span>

            <span class="c1"># setup parameters &quot;in time&quot;</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">Tend</span> <span class="o">=</span> <span class="mf">8.0</span>

        <span class="k">elif</span> <span class="n">setup</span> <span class="ow">is</span> <span class="s1">&#39;ADVECTION&#39;</span><span class="p">:</span>

            <span class="c1"># initialize problem parameters</span>
            <span class="n">problem_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
            <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

            <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.125</span>

            <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;periodic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># fill description dictionary for easy step instantiation</span>
            <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">advection1d</span>  <span class="c1"># pass problem class</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>  <span class="c1"># pass problem parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span>  <span class="c1"># pass data type for u</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span>  <span class="c1"># pass data type for f</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generic_implicit</span>  <span class="c1"># pass sweeper (see part B)</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>  <span class="c1"># pass sweeper parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>  <span class="c1"># pass level parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>  <span class="c1"># pass step parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_to_mesh</span>  <span class="c1"># pass spatial transfer class</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">space_transfer_params</span>  <span class="c1"># pass paramters for spatial transfer</span>

            <span class="c1"># setup parameters &quot;in time&quot;</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">Tend</span> <span class="o">=</span> <span class="mf">2.0</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;setup not implemented&#39;</span><span class="p">)</span>

        <span class="c1"># loop over all stategies and check how things evolve</span>
        <span class="k">for</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="n">ft_strategies</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Working on setup </span><span class="si">%s</span><span class="s1"> with strategy </span><span class="si">%s</span><span class="s1">..&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">setup</span><span class="p">,</span> <span class="n">strategy</span><span class="p">))</span>

            <span class="n">ft</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
            <span class="n">ft</span><span class="o">.</span><span class="n">hard_step</span> <span class="o">=</span> <span class="n">ft_step</span>
            <span class="n">ft</span><span class="o">.</span><span class="n">hard_iter</span> <span class="o">=</span> <span class="n">ft_iter</span>

            <span class="n">controller</span> <span class="o">=</span> <span class="n">allinclusive_classic_nonMPI_hard_faults</span><span class="p">(</span><span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">,</span>
                                                                 <span class="n">controller_params</span><span class="o">=</span><span class="n">controller_params</span><span class="p">,</span>
                                                                 <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

            <span class="c1"># get initial values on finest level</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">MS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span>
            <span class="n">uinit</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>

            <span class="c1"># call main function to get things done...</span>
            <span class="n">uend</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="n">uinit</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">Tend</span><span class="o">=</span><span class="n">Tend</span><span class="p">)</span>

            <span class="c1"># stats magic: get iteration counts to find maxiter/niter</span>
            <span class="n">extract_stats</span> <span class="o">=</span> <span class="n">filter_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">level</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;niter&#39;</span><span class="p">)</span>
            <span class="n">sortedlist_stats</span> <span class="o">=</span> <span class="n">sort_stats</span><span class="p">(</span><span class="n">extract_stats</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;process&#39;</span><span class="p">)</span>
            <span class="n">niter</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sortedlist_stats</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Iterations:&#39;</span><span class="p">,</span> <span class="n">niter</span><span class="p">)</span>

            <span class="n">residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">niter</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">))</span>
            <span class="n">residual</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span>

            <span class="c1"># stats magic: extract all residuals (steps vs. iterations)</span>
            <span class="n">extract_stats</span> <span class="o">=</span> <span class="n">filter_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;residual_post_iteration&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extract_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">step</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">)</span>
                <span class="nb">iter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;iter&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">residual</span><span class="p">[</span><span class="nb">iter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="s1">&#39;data/&#39;</span> <span class="o">+</span> <span class="n">setup</span> <span class="o">+</span> <span class="s1">&#39;_steps_vs_iteration_hf_&#39;</span> <span class="o">+</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">residual</span><span class="o">=</span><span class="n">residual</span><span class="p">,</span> <span class="n">ft_step</span><span class="o">=</span><span class="n">ft</span><span class="o">.</span><span class="n">hard_step</span><span class="p">,</span>
                     <span class="n">ft_iter</span><span class="o">=</span><span class="n">ft</span><span class="o">.</span><span class="n">hard_iter</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">ft_strategies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NOFAULT&#39;</span><span class="p">,</span> <span class="s1">&#39;SPREAD&#39;</span><span class="p">,</span> <span class="s1">&#39;SPREAD_PREDICT&#39;</span><span class="p">,</span> <span class="s1">&#39;INTERP&#39;</span><span class="p">,</span> <span class="s1">&#39;INTERP_PREDICT&#39;</span><span class="p">]</span>
    <span class="c1"># ft_setups = [&#39;ADVECTION&#39;, &#39;HEAT&#39;]</span>

    <span class="c1"># ft_strategies = [&#39;NOFAULT&#39;]</span>
    <span class="n">ft_setups</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;HEAT&#39;</span><span class="p">]</span>

    <span class="n">main</span><span class="p">(</span><span class="n">ft_setups</span><span class="o">=</span><span class="n">ft_setups</span><span class="p">,</span> <span class="n">ft_strategies</span><span class="o">=</span><span class="n">ft_strategies</span><span class="p">)</span>
</pre></div>
</div>
<p>Results (visualized by <code class="docutils literal notranslate"><span class="pre">postproc_hard_faults_detail</span></code>):</p>
<p>Heat equation:</p>
<a class="reference internal image-reference" href="../_images/HEAT_steps_vs_iteration_hf_7x7_NOFAULT.png"><img alt="../_images/HEAT_steps_vs_iteration_hf_7x7_NOFAULT.png" src="../_images/HEAT_steps_vs_iteration_hf_7x7_NOFAULT.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/HEAT_steps_vs_iteration_hf_7x7_SPREAD.png"><img alt="../_images/HEAT_steps_vs_iteration_hf_7x7_SPREAD.png" src="../_images/HEAT_steps_vs_iteration_hf_7x7_SPREAD.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/HEAT_steps_vs_iteration_hf_7x7_SPREAD_PREDICT.png"><img alt="../_images/HEAT_steps_vs_iteration_hf_7x7_SPREAD_PREDICT.png" src="../_images/HEAT_steps_vs_iteration_hf_7x7_SPREAD_PREDICT.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/HEAT_steps_vs_iteration_hf_7x7_INTERP.png"><img alt="../_images/HEAT_steps_vs_iteration_hf_7x7_INTERP.png" src="../_images/HEAT_steps_vs_iteration_hf_7x7_INTERP.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/HEAT_steps_vs_iteration_hf_7x7_INTERP_PREDICT.png"><img alt="../_images/HEAT_steps_vs_iteration_hf_7x7_INTERP_PREDICT.png" src="../_images/HEAT_steps_vs_iteration_hf_7x7_INTERP_PREDICT.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/HEAT_residuals_allstrategies.png"><img alt="../_images/HEAT_residuals_allstrategies.png" src="../_images/HEAT_residuals_allstrategies.png" style="width: 33%;" /></a>
<p>Advection equation:</p>
<a class="reference internal image-reference" href="../_images/ADVECTION_steps_vs_iteration_hf_7x7_NOFAULT.png"><img alt="../_images/ADVECTION_steps_vs_iteration_hf_7x7_NOFAULT.png" src="../_images/ADVECTION_steps_vs_iteration_hf_7x7_NOFAULT.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/ADVECTION_steps_vs_iteration_hf_7x7_SPREAD.png"><img alt="../_images/ADVECTION_steps_vs_iteration_hf_7x7_SPREAD.png" src="../_images/ADVECTION_steps_vs_iteration_hf_7x7_SPREAD.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/ADVECTION_steps_vs_iteration_hf_7x7_SPREAD_PREDICT.png"><img alt="../_images/ADVECTION_steps_vs_iteration_hf_7x7_SPREAD_PREDICT.png" src="../_images/ADVECTION_steps_vs_iteration_hf_7x7_SPREAD_PREDICT.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/ADVECTION_steps_vs_iteration_hf_7x7_INTERP.png"><img alt="../_images/ADVECTION_steps_vs_iteration_hf_7x7_INTERP.png" src="../_images/ADVECTION_steps_vs_iteration_hf_7x7_INTERP.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/ADVECTION_steps_vs_iteration_hf_7x7_INTERP_PREDICT.png"><img alt="../_images/ADVECTION_steps_vs_iteration_hf_7x7_INTERP_PREDICT.png" src="../_images/ADVECTION_steps_vs_iteration_hf_7x7_INTERP_PREDICT.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/ADVECTION_residuals_allstrategies.png"><img alt="../_images/ADVECTION_residuals_allstrategies.png" src="../_images/ADVECTION_residuals_allstrategies.png" style="width: 33%;" /></a>
</div>
<div class="section" id="node-failures-at-different-steps-and-iterations">
<h2>Node failures at different steps and iterations<a class="headerlink" href="#node-failures-at-different-steps-and-iterations" title="Permalink to this headline">¶</a></h2>
<p>The next step is to check how faults impact the convergence of PFASST at different steps and iterations.
We systematically study this in <code class="docutils literal notranslate"><span class="pre">hard_faults_test</span></code>, where for the heat and the advection equation each combination of step and iteraston is tested separately.
Heat maps generated by <code class="docutils literal notranslate"><span class="pre">postproc_hard_faults_test</span></code> then show how many more iterations are required to converge.</p>
<p>Full code: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/projects/node_failure/hard_faults_test.py">pySDC/projects/node_failure/hard_faults_test.py</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pySDC.implementations.problem_classes.HeatEquation_1D_FD_forced</span> <span class="k">import</span> <span class="n">heat1d_forced</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.problem_classes.AdvectionEquation_1D_FD</span> <span class="k">import</span> <span class="n">advection1d</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.transfer_classes.TransferMesh</span> <span class="k">import</span> <span class="n">mesh_to_mesh</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.datatype_classes.mesh</span> <span class="k">import</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">rhs_imex_mesh</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.imex_1st_order</span> <span class="k">import</span> <span class="n">imex_1st_order</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.generic_implicit</span> <span class="k">import</span> <span class="n">generic_implicit</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.collocation_classes.gauss_radau_right</span> <span class="k">import</span> <span class="n">CollGaussRadau_Right</span>

<span class="kn">from</span> <span class="nn">pySDC.helpers.stats_helper</span> <span class="k">import</span> <span class="n">filter_stats</span><span class="p">,</span> <span class="n">sort_stats</span>

<span class="kn">from</span> <span class="nn">pySDC.projects.node_failure.allinclusive_classic_nonMPI_hard_faults</span> <span class="k">import</span> <span class="n">allinclusive_classic_nonMPI_hard_faults</span>
<span class="kn">import</span> <span class="nn">pySDC.projects.node_failure.emulate_hard_faults</span> <span class="k">as</span> <span class="nn">ft</span>


<span class="c1"># noinspection PyShadowingNames,PyShadowingBuiltins</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">ft_setups</span><span class="p">,</span> <span class="n">ft_strategies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This routine generates the heatmaps showing the residual for node failures at different steps and iterations</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num_procs</span> <span class="o">=</span> <span class="mi">16</span>

    <span class="c1"># initialize level parameters</span>
    <span class="n">level_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-09</span>

    <span class="c1"># initialize step parameters</span>
    <span class="n">step_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">step_params</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="c1"># initialize space transfer parameters</span>
    <span class="n">space_transfer_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;finter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;rorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;iorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>

    <span class="c1"># initialize sweeper parameters</span>
    <span class="n">sweeper_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;collocation_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CollGaussRadau_Right</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># initialize controller parameters</span>
    <span class="n">controller_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;logger_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="k">for</span> <span class="n">setup</span> <span class="ow">in</span> <span class="n">ft_setups</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">setup</span> <span class="ow">is</span> <span class="s1">&#39;HEAT&#39;</span><span class="p">:</span>

            <span class="c1"># initialize problem parameters</span>
            <span class="n">problem_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">]</span>

            <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

            <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;periodic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># fill description dictionary for easy step instantiation</span>
            <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">heat1d_forced</span>  <span class="c1"># pass problem class</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>  <span class="c1"># pass problem parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span>  <span class="c1"># pass data type for u</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs_imex_mesh</span>  <span class="c1"># pass data type for f</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imex_1st_order</span>  <span class="c1"># pass sweeper (see part B)</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>  <span class="c1"># pass sweeper parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>  <span class="c1"># pass level parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>  <span class="c1"># pass step parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_to_mesh</span>  <span class="c1"># pass spatial transfer class</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">space_transfer_params</span>  <span class="c1"># pass paramters for spatial transfer</span>

            <span class="c1"># setup parameters &quot;in time&quot;</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">Tend</span> <span class="o">=</span> <span class="mf">8.0</span>

        <span class="k">elif</span> <span class="n">setup</span> <span class="ow">is</span> <span class="s1">&#39;ADVECTION&#39;</span><span class="p">:</span>

            <span class="c1"># initialize problem parameters</span>
            <span class="n">problem_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
            <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

            <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.125</span>

            <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;periodic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># fill description dictionary for easy step instantiation</span>
            <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">advection1d</span>  <span class="c1"># pass problem class</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>  <span class="c1"># pass problem parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span>  <span class="c1"># pass data type for u</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span>  <span class="c1"># pass data type for f</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generic_implicit</span>  <span class="c1"># pass sweeper (see part B)</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>  <span class="c1"># pass sweeper parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>  <span class="c1"># pass level parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>  <span class="c1"># pass step parameters</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_to_mesh</span>  <span class="c1"># pass spatial transfer class</span>
            <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">space_transfer_params</span>  <span class="c1"># pass paramters for spatial transfer</span>

            <span class="c1"># setup parameters &quot;in time&quot;</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">Tend</span> <span class="o">=</span> <span class="mf">2.0</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;setup not implemented&#39;</span><span class="p">)</span>

        <span class="c1"># do a reference run without any faults to see how things would look like (and to get maxiter/ref_niter)</span>
        <span class="n">ft</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="s1">&#39;NOFAULT&#39;</span>

        <span class="n">controller</span> <span class="o">=</span> <span class="n">allinclusive_classic_nonMPI_hard_faults</span><span class="p">(</span><span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">,</span>
                                                             <span class="n">controller_params</span><span class="o">=</span><span class="n">controller_params</span><span class="p">,</span>
                                                             <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

        <span class="c1"># get initial values on finest level</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">MS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span>
        <span class="n">uinit</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>

        <span class="c1"># call main function to get things done...</span>
        <span class="n">uend</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="n">uinit</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">Tend</span><span class="o">=</span><span class="n">Tend</span><span class="p">)</span>

        <span class="c1"># stats magic: get iteration counts to find maxiter/niter</span>
        <span class="n">extract_stats</span> <span class="o">=</span> <span class="n">filter_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">level</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;niter&#39;</span><span class="p">)</span>
        <span class="n">sortedlist_stats</span> <span class="o">=</span> <span class="n">sort_stats</span><span class="p">(</span><span class="n">extract_stats</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;process&#39;</span><span class="p">)</span>
        <span class="n">ref_niter</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sortedlist_stats</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Will sweep over </span><span class="si">%i</span><span class="s1"> steps and </span><span class="si">%i</span><span class="s1"> iterations now...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_procs</span><span class="p">,</span> <span class="n">ref_niter</span><span class="p">))</span>

        <span class="c1"># loop over all strategies</span>
        <span class="k">for</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="n">ft_strategies</span><span class="p">:</span>

            <span class="n">ft_iter</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ref_niter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ft_step</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------------------ working on strategy &#39;</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>

            <span class="n">iter_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ft_step</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ft_iter</span><span class="p">)))</span>

            <span class="c1"># loop over all steps</span>
            <span class="n">xcnt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">ft_step</span><span class="p">:</span>

                <span class="n">xcnt</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># loop over all iterations</span>
                <span class="n">ycnt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="n">ft_iter</span><span class="p">:</span>
                    <span class="n">ycnt</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">ft</span><span class="o">.</span><span class="n">hard_step</span> <span class="o">=</span> <span class="n">step</span>
                    <span class="n">ft</span><span class="o">.</span><span class="n">hard_iter</span> <span class="o">=</span> <span class="nb">iter</span>
                    <span class="n">ft</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>

                    <span class="c1"># call main function to get things done...</span>
                    <span class="n">uend</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="n">uinit</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">Tend</span><span class="o">=</span><span class="n">Tend</span><span class="p">)</span>

                    <span class="c1"># stats magic: get iteration counts to find maxiter/niter</span>
                    <span class="n">extract_stats</span> <span class="o">=</span> <span class="n">filter_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">level</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;niter&#39;</span><span class="p">)</span>
                    <span class="n">sortedlist_stats</span> <span class="o">=</span> <span class="n">sort_stats</span><span class="p">(</span><span class="n">extract_stats</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;process&#39;</span><span class="p">)</span>
                    <span class="n">niter</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sortedlist_stats</span><span class="p">])</span>
                    <span class="n">iter_count</span><span class="p">[</span><span class="n">xcnt</span><span class="p">,</span> <span class="n">ycnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">niter</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">iter_count</span><span class="p">)</span>

            <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="s1">&#39;data/&#39;</span> <span class="o">+</span> <span class="n">setup</span> <span class="o">+</span> <span class="s1">&#39;_results_hf_&#39;</span> <span class="o">+</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">iter_count</span><span class="o">=</span><span class="n">iter_count</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                     <span class="n">ft_step</span><span class="o">=</span><span class="n">ft_step</span><span class="p">,</span> <span class="n">ft_iter</span><span class="o">=</span><span class="n">ft_iter</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">ft_strategies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPREAD&#39;</span><span class="p">,</span> <span class="s1">&#39;SPREAD_PREDICT&#39;</span><span class="p">,</span> <span class="s1">&#39;INTERP&#39;</span><span class="p">,</span> <span class="s1">&#39;INTERP_PREDICT&#39;</span><span class="p">]</span>
    <span class="n">ft_setups</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ADVECTION&#39;</span><span class="p">,</span> <span class="s1">&#39;HEAT&#39;</span><span class="p">]</span>

    <span class="c1"># ft_strategies = [&#39;NOFAULT&#39;]</span>
    <span class="c1"># ft_setups = [&#39;HEAT&#39;]</span>

    <span class="n">main</span><span class="p">(</span><span class="n">ft_setups</span><span class="o">=</span><span class="n">ft_setups</span><span class="p">,</span> <span class="n">ft_strategies</span><span class="o">=</span><span class="n">ft_strategies</span><span class="p">)</span>
</pre></div>
</div>
<p>Results (visualized by <code class="docutils literal notranslate"><span class="pre">postproc_hard_faults_test</span></code>):</p>
<p>Heat equation:</p>
<a class="reference internal image-reference" href="../_images/HEAT_iteration_counts_hf_SPREAD.png"><img alt="../_images/HEAT_iteration_counts_hf_SPREAD.png" src="../_images/HEAT_iteration_counts_hf_SPREAD.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/HEAT_iteration_counts_hf_SPREAD_PREDICT.png"><img alt="../_images/HEAT_iteration_counts_hf_SPREAD_PREDICT.png" src="../_images/HEAT_iteration_counts_hf_SPREAD_PREDICT.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/HEAT_iteration_counts_hf_INTERP.png"><img alt="../_images/HEAT_iteration_counts_hf_INTERP.png" src="../_images/HEAT_iteration_counts_hf_INTERP.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/HEAT_iteration_counts_hf_INTERP_PREDICT.png"><img alt="../_images/HEAT_iteration_counts_hf_INTERP_PREDICT.png" src="../_images/HEAT_iteration_counts_hf_INTERP_PREDICT.png" style="width: 19%;" /></a>
<p>Advection equation:</p>
<a class="reference internal image-reference" href="../_images/ADVECTION_iteration_counts_hf_SPREAD.png"><img alt="../_images/ADVECTION_iteration_counts_hf_SPREAD.png" src="../_images/ADVECTION_iteration_counts_hf_SPREAD.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/ADVECTION_iteration_counts_hf_SPREAD_PREDICT.png"><img alt="../_images/ADVECTION_iteration_counts_hf_SPREAD_PREDICT.png" src="../_images/ADVECTION_iteration_counts_hf_SPREAD_PREDICT.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/ADVECTION_iteration_counts_hf_INTERP.png"><img alt="../_images/ADVECTION_iteration_counts_hf_INTERP.png" src="../_images/ADVECTION_iteration_counts_hf_INTERP.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/ADVECTION_iteration_counts_hf_INTERP_PREDICT.png"><img alt="../_images/ADVECTION_iteration_counts_hf_INTERP_PREDICT.png" src="../_images/ADVECTION_iteration_counts_hf_INTERP_PREDICT.png" style="width: 19%;" /></a>
</div>
<div class="section" id="the-boussinesq-test-case">
<h2>The Boussinesq test case<a class="headerlink" href="#the-boussinesq-test-case" title="Permalink to this headline">¶</a></h2>
<p>A first, more complex test case is the semi-implicit 2D Boussinesq system (order-coarsening only), see <code class="docutils literal notranslate"><span class="pre">boussinesq_example</span></code>.
We inject faults randomly with a rate of 3%, i.e. in 3% of all fine sweeps a node fails.
To ensure comparability, we define these fails a priori, so that each run has to deal with the same failures.
The <code class="docutils literal notranslate"><span class="pre">postproc_boussinesq</span></code> script visualizes the results.</p>
<p>Full code: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/projects/node_failure/boussinesq_example.py">pySDC/projects/node_failure/boussinesq_example.py</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pySDC.projects.node_failure.emulate_hard_faults</span> <span class="k">as</span> <span class="nn">ft</span>
<span class="kn">from</span> <span class="nn">pySDC.projects.node_failure.allinclusive_classic_nonMPI_hard_faults</span> <span class="k">import</span> <span class="n">allinclusive_classic_nonMPI_hard_faults</span>
<span class="kn">from</span> <span class="nn">pySDC.helpers.stats_helper</span> <span class="k">import</span> <span class="n">filter_stats</span><span class="p">,</span> <span class="n">sort_stats</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.collocation_classes.gauss_radau_right</span> <span class="k">import</span> <span class="n">CollGaussRadau_Right</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.datatype_classes.mesh</span> <span class="k">import</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">rhs_imex_mesh</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.problem_classes.Boussinesq_2D_FD_imex</span> <span class="k">import</span> <span class="n">boussinesq_2d_imex</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.imex_1st_order</span> <span class="k">import</span> <span class="n">imex_1st_order</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.transfer_classes.TransferMesh_NoCoarse</span> <span class="k">import</span> <span class="n">mesh_to_mesh</span>


<span class="c1"># noinspection PyShadowingNames,PyShadowingBuiltins</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">ft_strategies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This routine generates the heatmaps showing the residual for node failures at different steps and iterations</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num_procs</span> <span class="o">=</span> <span class="mi">16</span>

    <span class="c1"># setup parameters &quot;in time&quot;</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Tend</span> <span class="o">=</span> <span class="mi">960</span>
    <span class="n">Nsteps</span> <span class="o">=</span> <span class="mi">320</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">Tend</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">Nsteps</span><span class="p">)</span>

    <span class="c1"># initialize level parameters</span>
    <span class="n">level_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-06</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>

    <span class="c1"># initialize step parameters</span>
    <span class="n">step_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">step_params</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="c1"># initialize space transfer parameters</span>
    <span class="n">space_transfer_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;finter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;rorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;iorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>

    <span class="c1"># initialize sweeper parameters</span>
    <span class="n">sweeper_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;collocation_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CollGaussRadau_Right</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;QI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;LU&#39;</span>

    <span class="c1"># initialize controller parameters</span>
    <span class="n">controller_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;logger_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="c1"># initialize problem parameters</span>
    <span class="n">problem_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c1"># problem_params[&#39;nvars&#39;] = [(4, 450, 30), (4, 450, 30)]</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">)]</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;u_adv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.02</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;c_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;Nfreq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;x_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mf">150.0</span><span class="p">,</span> <span class="mf">150.0</span><span class="p">)]</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;z_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)]</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;order_upw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;gmres_maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;gmres_restart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;gmres_tol_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e-10</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">]</span>

    <span class="c1"># fill description dictionary for easy step instantiation</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boussinesq_2d_imex</span>  <span class="c1"># pass problem class</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>  <span class="c1"># pass problem parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh</span>  <span class="c1"># pass data type for u</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs_imex_mesh</span>  <span class="c1"># pass data type for f</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imex_1st_order</span>  <span class="c1"># pass sweeper (see part B)</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>  <span class="c1"># pass sweeper parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>  <span class="c1"># pass level parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>  <span class="c1"># pass step parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_to_mesh</span>  <span class="c1"># pass spatial transfer class</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">space_transfer_params</span>  <span class="c1"># pass paramters for spatial transfer</span>

    <span class="n">ft</span><span class="o">.</span><span class="n">hard_random</span> <span class="o">=</span> <span class="mf">0.03</span>

    <span class="n">controller</span> <span class="o">=</span> <span class="n">allinclusive_classic_nonMPI_hard_faults</span><span class="p">(</span><span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">,</span>
                                                         <span class="n">controller_params</span><span class="o">=</span><span class="n">controller_params</span><span class="p">,</span>
                                                         <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

    <span class="c1"># get initial values on finest level</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">MS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span>
    <span class="n">uinit</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>

    <span class="n">cfl_advection</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">u_adv</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">P</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cfl_acoustic_hor</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">c_s</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">P</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cfl_acoustic_ver</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">c_s</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">P</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CFL number of advection: </span><span class="si">%4.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cfl_advection</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CFL number of acoustics (horizontal): </span><span class="si">%4.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cfl_acoustic_hor</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CFL number of acoustics (vertical):   </span><span class="si">%4.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cfl_acoustic_ver</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="n">ft_strategies</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------------------ working on strategy &#39;</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>
        <span class="n">ft</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>

        <span class="c1"># read in reference data from clean run, will provide reproducable locations for faults</span>
        <span class="k">if</span> <span class="n">strategy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;NOFAULT&#39;</span><span class="p">:</span>
            <span class="n">reffile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;data/PFASST_BOUSSINESQ_stats_hf_NOFAULT_P16.npz&#39;</span><span class="p">)</span>
            <span class="n">ft</span><span class="o">.</span><span class="n">refdata</span> <span class="o">=</span> <span class="n">reffile</span><span class="p">[</span><span class="s1">&#39;hard_stats&#39;</span><span class="p">]</span>

        <span class="c1"># call main function to get things done...</span>
        <span class="n">uend</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="n">uinit</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">Tend</span><span class="o">=</span><span class="n">Tend</span><span class="p">)</span>

        <span class="n">P</span><span class="o">.</span><span class="n">report_log</span><span class="p">()</span>

        <span class="c1"># get residuals of the run</span>
        <span class="n">extract_stats</span> <span class="o">=</span> <span class="n">filter_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;residual_post_iteration&#39;</span><span class="p">)</span>

        <span class="c1"># find boundaries for x-,y- and c-axis as well as arrays</span>
        <span class="n">maxprocs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">maxiter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">minres</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">maxres</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extract_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">maxprocs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxprocs</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">))</span>
            <span class="n">maxiter</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxiter</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;iter&#39;</span><span class="p">))</span>
            <span class="n">minres</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">minres</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="n">maxres</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxres</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="c1"># grep residuals and put into array</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">maxiter</span><span class="p">,</span> <span class="n">maxprocs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">residual</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extract_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">)</span>
            <span class="nb">iter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;iter&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">residual</span><span class="p">[</span><span class="nb">iter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="c1"># stats magic: get niter (probably redundant with maxiter)</span>
        <span class="n">extract_stats</span> <span class="o">=</span> <span class="n">filter_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">level</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;niter&#39;</span><span class="p">)</span>
        <span class="n">sortedlist_stats</span> <span class="o">=</span> <span class="n">sort_stats</span><span class="p">(</span><span class="n">extract_stats</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;process&#39;</span><span class="p">)</span>
        <span class="n">iter_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nsteps</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sortedlist_stats</span><span class="p">:</span>
            <span class="n">iter_count</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">iter_count</span><span class="p">)</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="s1">&#39;data/PFASST_BOUSSINESQ_stats_hf_&#39;</span> <span class="o">+</span> <span class="n">ft</span><span class="o">.</span><span class="n">strategy</span> <span class="o">+</span> <span class="s1">&#39;_P&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_procs</span><span class="p">),</span> <span class="n">residual</span><span class="o">=</span><span class="n">residual</span><span class="p">,</span>
                 <span class="n">iter_count</span><span class="o">=</span><span class="n">iter_count</span><span class="p">,</span> <span class="n">hard_stats</span><span class="o">=</span><span class="n">ft</span><span class="o">.</span><span class="n">hard_stats</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># ft_strategies = [&#39;SPREAD&#39;, &#39;SPREAD_PREDICT&#39;, &#39;INTERP&#39;, &#39;INTERP_PREDICT&#39;]</span>
    <span class="n">ft_strategies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NOFAULT&#39;</span><span class="p">]</span>

    <span class="n">main</span><span class="p">(</span><span class="n">ft_strategies</span><span class="o">=</span><span class="n">ft_strategies</span><span class="p">)</span>
</pre></div>
</div>
<p>Results (visualized by <code class="docutils literal notranslate"><span class="pre">postproc_boussines</span></code>):</p>
<a class="reference internal image-reference" href="../_images/BOUSSINESQ_steps_vs_iteration_hf_SPREAD.png"><img alt="../_images/BOUSSINESQ_steps_vs_iteration_hf_SPREAD.png" src="../_images/BOUSSINESQ_steps_vs_iteration_hf_SPREAD.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/BOUSSINESQ_steps_vs_iteration_hf_SPREAD_PREDICT.png"><img alt="../_images/BOUSSINESQ_steps_vs_iteration_hf_SPREAD_PREDICT.png" src="../_images/BOUSSINESQ_steps_vs_iteration_hf_SPREAD_PREDICT.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/BOUSSINESQ_steps_vs_iteration_hf_INTERP.png"><img alt="../_images/BOUSSINESQ_steps_vs_iteration_hf_INTERP.png" src="../_images/BOUSSINESQ_steps_vs_iteration_hf_INTERP.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/BOUSSINESQ_steps_vs_iteration_hf_INTERP_PREDICT.png"><img alt="../_images/BOUSSINESQ_steps_vs_iteration_hf_INTERP_PREDICT.png" src="../_images/BOUSSINESQ_steps_vs_iteration_hf_INTERP_PREDICT.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/BOUSSINESQ_steps_vs_iteration_hf_INTERP_PREDICT.png"><img alt="../_images/BOUSSINESQ_steps_vs_iteration_hf_INTERP_PREDICT.png" src="../_images/BOUSSINESQ_steps_vs_iteration_hf_INTERP_PREDICT.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/BOUSSINESQ_Kadd_vs_NOFAULT_hf.png"><img alt="../_images/BOUSSINESQ_Kadd_vs_NOFAULT_hf.png" src="../_images/BOUSSINESQ_Kadd_vs_NOFAULT_hf.png" style="width: 33%;" /></a>
</div>
<div class="section" id="the-gray-scott-test-case">
<h2>The Gray-Scott test case<a class="headerlink" href="#the-gray-scott-test-case" title="Permalink to this headline">¶</a></h2>
<p>Another test case is the 1D Gray-Scott reaction diffusion model, see <code class="docutils literal notranslate"><span class="pre">grayscott_example</span></code>.
With spatial coarsening enabled, this application plays well with PFASST and the goal of this part is to see how fault injections and recovery impact the convergence.
We again inject faults randomly, but in a pre-defined way with a rate of 3%.
The <code class="docutils literal notranslate"><span class="pre">postproc_grayscott</span></code> script visualizes the results. Also, the script <code class="docutils literal notranslate"><span class="pre">animate_convergence</span></code> can be used to create an animated convergence plot (and can be easily adapted for other examples, too).</p>
<p>Full code: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/projects/node_failure/grayscott_example.py">pySDC/projects/node_failure/grayscott_example.py</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pySDC.projects.node_failure.emulate_hard_faults</span> <span class="k">as</span> <span class="nn">ft</span>
<span class="kn">from</span> <span class="nn">pySDC.projects.node_failure.allinclusive_classic_nonMPI_hard_faults</span> <span class="k">import</span> <span class="n">allinclusive_classic_nonMPI_hard_faults</span>
<span class="kn">from</span> <span class="nn">pySDC.helpers.stats_helper</span> <span class="k">import</span> <span class="n">filter_stats</span><span class="p">,</span> <span class="n">sort_stats</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.collocation_classes.gauss_radau_right</span> <span class="k">import</span> <span class="n">CollGaussRadau_Right</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.generic_LU</span> <span class="k">import</span> <span class="n">generic_LU</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.datatype_classes.fenics_mesh</span> <span class="k">import</span> <span class="n">fenics_mesh</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.transfer_classes.TransferFenicsMesh</span> <span class="k">import</span> <span class="n">mesh_to_mesh_fenics</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.problem_classes.GrayScott_1D_FEniCS_implicit</span> <span class="k">import</span> <span class="n">fenics_grayscott</span>


<span class="c1"># noinspection PyShadowingNames,PyShadowingBuiltins</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">ft_strategies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This routine generates the heatmaps showing the residual for node failures at different steps and iterations</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num_procs</span> <span class="o">=</span> <span class="mi">32</span>

    <span class="c1"># setup parameters &quot;in time&quot;</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">Tend</span> <span class="o">=</span> <span class="mf">1280.0</span>
    <span class="n">Nsteps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">Tend</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>

    <span class="c1"># initialize level parameters</span>
    <span class="n">level_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-07</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>

    <span class="c1"># initialize step parameters</span>
    <span class="n">step_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">step_params</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="c1"># initialize space transfer parameters</span>
    <span class="n">space_transfer_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">space_transfer_params</span><span class="p">[</span><span class="s1">&#39;finter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># initialize sweeper parameters</span>
    <span class="n">sweeper_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;collocation_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CollGaussRadau_Right</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;QI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;LU&#39;</span>

    <span class="c1"># initialize controller parameters</span>
    <span class="n">controller_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;logger_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="c1"># initialize problem parameters</span>
    <span class="n">problem_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c1"># problem_params[&#39;Du&#39;] = 1.0</span>
    <span class="c1"># problem_params[&#39;Dv&#39;] = 0.01</span>
    <span class="c1"># problem_params[&#39;A&#39;] = 0.01</span>
    <span class="c1"># problem_params[&#39;B&#39;] = 0.10</span>
    <span class="c1"># splitting pulses until steady state</span>
    <span class="c1"># problem_params[&#39;Du&#39;] = 1.0</span>
    <span class="c1"># problem_params[&#39;Dv&#39;] = 0.01</span>
    <span class="c1"># problem_params[&#39;A&#39;] = 0.02</span>
    <span class="c1"># problem_params[&#39;B&#39;] = 0.079</span>
    <span class="c1"># splitting pulses until steady state</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;Du&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;Dv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.09</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.086</span>

    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t0</span>  <span class="c1"># ugly, but necessary to set up ProblemClass</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;c_nvars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">256</span><span class="p">]</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;family&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CG&#39;</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;refinements&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># fill description dictionary for easy step instantiation</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fenics_grayscott</span>  <span class="c1"># pass problem class</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>  <span class="c1"># pass problem parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fenics_mesh</span>  <span class="c1"># pass data type for u</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fenics_mesh</span>  <span class="c1"># pass data type for f</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generic_LU</span>  <span class="c1"># pass sweeper (see part B)</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>  <span class="c1"># pass sweeper parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>  <span class="c1"># pass level parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>  <span class="c1"># pass step parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mesh_to_mesh_fenics</span>  <span class="c1"># pass spatial transfer class</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;space_transfer_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">space_transfer_params</span>  <span class="c1"># pass paramters for spatial transfer</span>

    <span class="n">ft</span><span class="o">.</span><span class="n">hard_random</span> <span class="o">=</span> <span class="mf">0.03</span>

    <span class="n">controller</span> <span class="o">=</span> <span class="n">allinclusive_classic_nonMPI_hard_faults</span><span class="p">(</span><span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">,</span>
                                                         <span class="n">controller_params</span><span class="o">=</span><span class="n">controller_params</span><span class="p">,</span>
                                                         <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

    <span class="c1"># get initial values on finest level</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">MS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span>
    <span class="n">uinit</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="n">ft_strategies</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------------------------------------ working on strategy &#39;</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>
        <span class="n">ft</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>

        <span class="c1"># read in reference data from clean run, will provide reproducable locations for faults</span>
        <span class="k">if</span> <span class="n">strategy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;NOFAULT&#39;</span><span class="p">:</span>
            <span class="n">reffile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;data/PFASST_GRAYSCOTT_stats_hf_NOFAULT_P16.npz&#39;</span><span class="p">)</span>
            <span class="n">ft</span><span class="o">.</span><span class="n">refdata</span> <span class="o">=</span> <span class="n">reffile</span><span class="p">[</span><span class="s1">&#39;hard_stats&#39;</span><span class="p">]</span>

        <span class="c1"># call main function to get things done...</span>
        <span class="n">uend</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="n">uinit</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">Tend</span><span class="o">=</span><span class="n">Tend</span><span class="p">)</span>

        <span class="c1"># get residuals of the run</span>
        <span class="n">extract_stats</span> <span class="o">=</span> <span class="n">filter_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;residual_post_iteration&#39;</span><span class="p">)</span>

        <span class="c1"># find boundaries for x-,y- and c-axis as well as arrays</span>
        <span class="n">maxprocs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">maxiter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">minres</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">maxres</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extract_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">maxprocs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxprocs</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">))</span>
            <span class="n">maxiter</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxiter</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;iter&#39;</span><span class="p">))</span>
            <span class="n">minres</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">minres</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="n">maxres</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxres</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="c1"># grep residuals and put into array</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">maxiter</span><span class="p">,</span> <span class="n">maxprocs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">residual</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extract_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">step</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">)</span>
            <span class="nb">iter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;iter&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">residual</span><span class="p">[</span><span class="nb">iter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="c1"># stats magic: get niter (probably redundant with maxiter)</span>
        <span class="n">extract_stats</span> <span class="o">=</span> <span class="n">filter_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">level</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;niter&#39;</span><span class="p">)</span>
        <span class="n">sortedlist_stats</span> <span class="o">=</span> <span class="n">sort_stats</span><span class="p">(</span><span class="n">extract_stats</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;process&#39;</span><span class="p">)</span>
        <span class="n">iter_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nsteps</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sortedlist_stats</span><span class="p">:</span>
            <span class="n">iter_count</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">iter_count</span><span class="p">)</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="s1">&#39;data/PFASST_GRAYSCOTT_stats_hf_&#39;</span> <span class="o">+</span> <span class="n">ft</span><span class="o">.</span><span class="n">strategy</span> <span class="o">+</span> <span class="s1">&#39;_P&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_procs</span><span class="p">),</span> <span class="n">residual</span><span class="o">=</span><span class="n">residual</span><span class="p">,</span>
                 <span class="n">iter_count</span><span class="o">=</span><span class="n">iter_count</span><span class="p">,</span> <span class="n">hard_stats</span><span class="o">=</span><span class="n">ft</span><span class="o">.</span><span class="n">hard_stats</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># ft_strategies = [&#39;SPREAD&#39;, &#39;SPREAD_PREDICT&#39;, &#39;INTERP&#39;, &#39;INTERP_PREDICT&#39;]</span>
    <span class="n">ft_strategies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NOFAULT&#39;</span><span class="p">]</span>

    <span class="n">main</span><span class="p">(</span><span class="n">ft_strategies</span><span class="o">=</span><span class="n">ft_strategies</span><span class="p">)</span>
</pre></div>
</div>
<p>Results (visualized by <code class="docutils literal notranslate"><span class="pre">postproc_grayscott</span></code>):</p>
<a class="reference internal image-reference" href="../_images/GRAYSCOTT_steps_vs_iteration_hf_SPREAD.png"><img alt="../_images/GRAYSCOTT_steps_vs_iteration_hf_SPREAD.png" src="../_images/GRAYSCOTT_steps_vs_iteration_hf_SPREAD.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/GRAYSCOTT_steps_vs_iteration_hf_SPREAD_PREDICT.png"><img alt="../_images/GRAYSCOTT_steps_vs_iteration_hf_SPREAD_PREDICT.png" src="../_images/GRAYSCOTT_steps_vs_iteration_hf_SPREAD_PREDICT.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/GRAYSCOTT_steps_vs_iteration_hf_INTERP.png"><img alt="../_images/GRAYSCOTT_steps_vs_iteration_hf_INTERP.png" src="../_images/GRAYSCOTT_steps_vs_iteration_hf_INTERP.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/GRAYSCOTT_steps_vs_iteration_hf_INTERP_PREDICT.png"><img alt="../_images/GRAYSCOTT_steps_vs_iteration_hf_INTERP_PREDICT.png" src="../_images/GRAYSCOTT_steps_vs_iteration_hf_INTERP_PREDICT.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/GRAYSCOTT_steps_vs_iteration_hf_INTERP_PREDICT.png"><img alt="../_images/GRAYSCOTT_steps_vs_iteration_hf_INTERP_PREDICT.png" src="../_images/GRAYSCOTT_steps_vs_iteration_hf_INTERP_PREDICT.png" style="width: 19%;" /></a>
<a class="reference internal image-reference" href="../_images/GRAYSCOTT_Kadd_vs_NOFAULT_hf.png"><img alt="../_images/GRAYSCOTT_Kadd_vs_NOFAULT_hf.png" src="../_images/GRAYSCOTT_Kadd_vs_NOFAULT_hf.png" style="width: 33%;" /></a>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Fault-tolerance with PFASST: node failures</a><ul>
<li><a class="reference internal" href="#propagation-of-a-single-node-failure">Propagation of a single node failure</a></li>
<li><a class="reference internal" href="#node-failures-at-different-steps-and-iterations">Node failures at different steps and iterations</a></li>
<li><a class="reference internal" href="#the-boussinesq-test-case">The Boussinesq test case</a></li>
<li><a class="reference internal" href="#the-gray-scott-test-case">The Gray-Scott test case</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="parallelSDC.html"
                        title="previous chapter">Attempts to parallelize SDC</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="fwsw.html"
                        title="next chapter">Fast-Wave-Slow-Wave SDC</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/projects/node_failure.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="fwsw.html" title="Fast-Wave-Slow-Wave SDC"
             >next</a> |</li>
        <li class="right" >
          <a href="parallelSDC.html" title="Attempts to parallelize SDC"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pySDC 2 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Robert Speck.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>