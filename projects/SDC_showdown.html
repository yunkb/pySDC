
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>What is the fastest SDC variant? &#8212; pySDC 2 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="core package" href="../pySDC/core.html" />
    <link rel="prev" title="Second-order Problems" href="Hamiltonian.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../pySDC/core.html" title="core package"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Hamiltonian.html" title="Second-order Problems"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pySDC 2 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="what-is-the-fastest-sdc-variant">
<h1>What is the fastest SDC variant?<a class="headerlink" href="#what-is-the-fastest-sdc-variant" title="Permalink to this headline">¶</a></h1>
<p>In this project, we test different variants of SDC for a particular problem to see which one is the fastest.
More precisely, we run SDC for the 1D Fisher equation and the 2D Gray-Scott problem with PETSc data types and solvers, using fully implicit, semi-implicit and multi-implicit time-stepping.
We also test exact spatial solves vs. inexact ones (aka inexact SDC, ISDC)</p>
<div class="section" id="fisher-and-gray-scott-equations">
<h2>Fisher and Gray-Scott equations<a class="headerlink" href="#fisher-and-gray-scott-equations" title="Permalink to this headline">¶</a></h2>
<p>The two run scripts simply test all variants of SDC after the other, each of them exact and then inexact.
The results are gathered, stored and shown in comparison.
Note that on standard machines the inexact semi-implicit variant wins each time (may be different for the CI testing).</p>
<p>Full code: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/projects/SDC_showdown/SDC_timing_Fisher.py">pySDC/projects/SDC_showdown/SDC_timing_Fisher.py</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pySDC.implementations.problem_classes.GeneralizedFisher_1D_PETSc</span> <span class="k">import</span> <span class="n">petsc_fisher_multiimplicit</span><span class="p">,</span> \
    <span class="n">petsc_fisher_fullyimplicit</span><span class="p">,</span> <span class="n">petsc_fisher_semiimplicit</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.datatype_classes.petsc_dmda_grid</span> <span class="k">import</span> <span class="n">petsc_data</span><span class="p">,</span> <span class="n">rhs_2comp_petsc_data</span><span class="p">,</span> <span class="n">rhs_imex_petsc_data</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.collocation_classes.gauss_radau_right</span> <span class="k">import</span> <span class="n">CollGaussRadau_Right</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.multi_implicit</span> <span class="k">import</span> <span class="n">multi_implicit</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.imex_1st_order</span> <span class="k">import</span> <span class="n">imex_1st_order</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.generic_implicit</span> <span class="k">import</span> <span class="n">generic_implicit</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.transfer_classes.TransferPETScDMDA</span> <span class="k">import</span> <span class="n">mesh_to_mesh_petsc_dmda</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.controller_classes.allinclusive_multigrid_nonMPI</span> <span class="k">import</span> <span class="n">allinclusive_multigrid_nonMPI</span>

<span class="kn">from</span> <span class="nn">pySDC.helpers.stats_helper</span> <span class="k">import</span> <span class="n">filter_stats</span><span class="p">,</span> <span class="n">sort_stats</span>
<span class="kn">import</span> <span class="nn">pySDC.helpers.plot_helper</span> <span class="k">as</span> <span class="nn">plt_helper</span>


<span class="k">def</span> <span class="nf">setup_parameters</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper routine to fill in all relevant parameters</span>

<span class="sd">    Note that this file will be used for all versions of SDC, containing more than necessary for each individual run</span>

<span class="sd">    Returns:</span>
<span class="sd">        description (dict)</span>
<span class="sd">        controller_params (dict)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialize level parameters</span>
    <span class="n">level_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-06</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.25</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;nsweeps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># initialize sweeper parameters</span>
    <span class="n">sweeper_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;collocation_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CollGaussRadau_Right</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;Q1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LU&#39;</span><span class="p">]</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;Q2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LU&#39;</span><span class="p">]</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;QI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LU&#39;</span><span class="p">]</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;spread&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># initialize problem parameters</span>
    <span class="n">problem_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2049</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;lambda0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nlsol_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-10</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nlsol_maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;lsol_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-10</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;lsol_maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="c1"># initialize step parameters</span>
    <span class="n">step_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">step_params</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="c1"># initialize space transfer parameters</span>
    <span class="c1"># space_transfer_params = dict()</span>
    <span class="c1"># space_transfer_params[&#39;finter&#39;] = True</span>

    <span class="c1"># initialize controller parameters</span>
    <span class="n">controller_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;logger_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="c1"># fill description dictionary for easy step instantiation</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># pass problem class</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>  <span class="c1"># pass problem parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">petsc_data</span>  <span class="c1"># pass data type for u</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># pass data type for f</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># pass sweeper (see part B)</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>  <span class="c1"># pass sweeper parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>  <span class="c1"># pass level parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>  <span class="c1"># pass step parameters</span>
    <span class="c1"># description[&#39;space_transfer_class&#39;] = mesh_to_mesh_petsc_dmda  # pass spatial transfer class</span>
    <span class="c1"># description[&#39;space_transfer_params&#39;] = space_transfer_params  # pass paramters for spatial transfer</span>

    <span class="k">return</span> <span class="n">description</span><span class="p">,</span> <span class="n">controller_params</span>


<span class="k">def</span> <span class="nf">run_SDC_variant</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inexact</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Routine to run particular SDC variant</span>

<span class="sd">    Args:</span>
<span class="sd">        variant (str): string describing the variant</span>
<span class="sd">        inexact (bool): flag to use inexact nonlinear solve (or nor)</span>

<span class="sd">    Returns:</span>
<span class="sd">        timing (float)</span>
<span class="sd">        niter (float)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># load (incomplete) default parameters</span>
    <span class="n">description</span><span class="p">,</span> <span class="n">controller_params</span> <span class="o">=</span> <span class="n">setup_parameters</span><span class="p">()</span>

    <span class="c1"># add stuff based on variant</span>
    <span class="k">if</span> <span class="n">variant</span> <span class="o">==</span> <span class="s1">&#39;fully-implicit&#39;</span><span class="p">:</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">petsc_fisher_fullyimplicit</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">petsc_data</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generic_implicit</span>
    <span class="k">elif</span> <span class="n">variant</span> <span class="o">==</span> <span class="s1">&#39;semi-implicit&#39;</span><span class="p">:</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">petsc_fisher_semiimplicit</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs_imex_petsc_data</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imex_1st_order</span>
    <span class="k">elif</span> <span class="n">variant</span> <span class="o">==</span> <span class="s1">&#39;multi-implicit&#39;</span><span class="p">:</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">petsc_fisher_multiimplicit</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs_2comp_petsc_data</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_implicit</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s1">&#39;Wrong variant specified, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">variant</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">inexact</span><span class="p">:</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">][</span><span class="s1">&#39;nlsol_maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Working on inexact </span><span class="si">%s</span><span class="s1"> variant...&#39;</span> <span class="o">%</span> <span class="n">variant</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Working on exact </span><span class="si">%s</span><span class="s1"> variant...&#39;</span> <span class="o">%</span> <span class="n">variant</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="c1"># set time parameters</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">Tend</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c1"># instantiate controller</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="n">allinclusive_multigrid_nonMPI</span><span class="p">(</span><span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">controller_params</span><span class="o">=</span><span class="n">controller_params</span><span class="p">,</span>
                                               <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

    <span class="c1"># get initial values on finest level</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">MS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span>
    <span class="n">uinit</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>

    <span class="c1"># call main function to get things done...</span>
    <span class="n">uend</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="n">uinit</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">Tend</span><span class="o">=</span><span class="n">Tend</span><span class="p">)</span>

    <span class="c1"># compute exact solution and compare</span>
    <span class="n">uex</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">Tend</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">uex</span> <span class="o">-</span> <span class="n">uend</span><span class="p">)</span>

    <span class="c1"># filter statistics by variant (number of iterations)</span>
    <span class="n">filtered_stats</span> <span class="o">=</span> <span class="n">filter_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;niter&#39;</span><span class="p">)</span>

    <span class="c1"># convert filtered statistics to list of iterations count, sorted by process</span>
    <span class="n">iter_counts</span> <span class="o">=</span> <span class="n">sort_stats</span><span class="p">(</span><span class="n">filtered_stats</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="c1"># compute and print statistics</span>
    <span class="n">niters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iter_counts</span><span class="p">])</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Mean number of iterations: </span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Range of values for number of iterations: </span><span class="si">%2i</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Position of max/min number of iterations: </span><span class="si">%2i</span><span class="s1"> -- </span><span class="si">%2i</span><span class="s1">&#39;</span> <span class="o">%</span> \
          <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">niters</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">niters</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Std and var for number of iterations: </span><span class="si">%4.2f</span><span class="s1"> -- </span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">niters</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">niters</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Iteration count (nonlinear/linear): </span><span class="si">%i</span><span class="s1"> / </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">snes_itercount</span><span class="p">,</span> <span class="n">P</span><span class="o">.</span><span class="n">ksp_itercount</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean Iteration count per call: </span><span class="si">%4.2f</span><span class="s1"> / </span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">snes_itercount</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">snes_ncalls</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                            <span class="n">P</span><span class="o">.</span><span class="n">ksp_itercount</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">ksp_ncalls</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="n">timing</span> <span class="o">=</span> <span class="n">sort_stats</span><span class="p">(</span><span class="n">filter_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;timing_run&#39;</span><span class="p">),</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time to solution: </span><span class="si">%6.4f</span><span class="s1"> sec.&#39;</span> <span class="o">%</span> <span class="n">timing</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error vs. PDE solution: </span><span class="si">%6.4e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mf">7E-05</span><span class="p">,</span> <span class="s1">&#39;ERROR: variant </span><span class="si">%s</span><span class="s1"> did not match error tolerance, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">variant</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;ERROR: number of iterations is too high, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">timing</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">show_results</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plotting routine</span>

<span class="sd">    Args:</span>
<span class="sd">        fname: file name to read in and name plots</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">plt_helper</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;classic&#39;</span><span class="p">)</span>
    <span class="n">plt_helper</span><span class="o">.</span><span class="n">setup_mpl</span><span class="p">()</span>

    <span class="n">plt_helper</span><span class="o">.</span><span class="n">newfig</span><span class="p">(</span><span class="n">textwidth</span><span class="o">=</span><span class="mf">238.96</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">xcoords</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))]</span>
    <span class="n">sorted_data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sorted_data</span><span class="p">]</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sorted_data</span><span class="p">]</span>

    <span class="n">plt_helper</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">xcoords</span><span class="p">,</span> <span class="n">heights</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

    <span class="n">plt_helper</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xcoords</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">plt_helper</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;time (sec)&#39;</span><span class="p">)</span>

    <span class="c1"># save plot, beautify</span>
    <span class="n">plt_helper</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">),</span> <span class="s1">&#39;ERROR: plotting did not create PDF file&#39;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.pgf&#39;</span><span class="p">),</span> <span class="s1">&#39;ERROR: plotting did not create PGF file&#39;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">),</span> <span class="s1">&#39;ERROR: plotting did not create PNG file&#39;</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main driver</span>

<span class="sd">    Args:</span>
<span class="sd">        cwd (str): current working directory (need this for testing)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Loop over variants, exact and inexact solves</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fully-implicit&#39;</span><span class="p">,</span> <span class="s1">&#39;multi-implicit&#39;</span><span class="p">,</span> <span class="s1">&#39;semi-implicit&#39;</span><span class="p">]:</span>

        <span class="n">results</span><span class="p">[(</span><span class="n">variant</span><span class="p">,</span> <span class="s1">&#39;exact&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">run_SDC_variant</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="n">variant</span><span class="p">,</span> <span class="n">inexact</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[(</span><span class="n">variant</span><span class="p">,</span> <span class="s1">&#39;inexact&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">run_SDC_variant</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="n">variant</span><span class="p">,</span> <span class="n">inexact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># dump result</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;data/timings_SDC_variants_Fisher&#39;</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="s1">&#39;ERROR: pickle did not create file&#39;</span>

    <span class="c1"># visualize</span>
    <span class="n">show_results</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Results:</p>
<a class="reference internal image-reference" href="../_images/timings_SDC_variants_Fisher.png"><img alt="../_images/timings_SDC_variants_Fisher.png" src="../_images/timings_SDC_variants_Fisher.png" style="width: 287.0px; height: 234.0px;" /></a>
<p>Full code: <a class="reference external" href="https://github.com/Parallel-in-Time/pySDC/blob/master/pySDC/projects/SDC_showdown/SDC_timing_GrayScott.py">pySDC/projects/SDC_showdown/SDC_timing_GrayScott.py</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="k">import</span> <span class="n">PETSc</span>

<span class="kn">from</span> <span class="nn">pySDC.implementations.problem_classes.GrayScott_2D_PETSc_periodic</span> <span class="k">import</span> <span class="n">petsc_grayscott_multiimplicit</span><span class="p">,</span> \
    <span class="n">petsc_grayscott_fullyimplicit</span><span class="p">,</span> <span class="n">petsc_grayscott_semiimplicit</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.datatype_classes.petsc_dmda_grid</span> <span class="k">import</span> <span class="n">petsc_data</span><span class="p">,</span> <span class="n">rhs_2comp_petsc_data</span><span class="p">,</span> <span class="n">rhs_imex_petsc_data</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.collocation_classes.gauss_radau_right</span> <span class="k">import</span> <span class="n">CollGaussRadau_Right</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.multi_implicit</span> <span class="k">import</span> <span class="n">multi_implicit</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.imex_1st_order</span> <span class="k">import</span> <span class="n">imex_1st_order</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.sweeper_classes.generic_implicit</span> <span class="k">import</span> <span class="n">generic_implicit</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.transfer_classes.TransferPETScDMDA</span> <span class="k">import</span> <span class="n">mesh_to_mesh_petsc_dmda</span>
<span class="kn">from</span> <span class="nn">pySDC.implementations.controller_classes.allinclusive_multigrid_nonMPI</span> <span class="k">import</span> <span class="n">allinclusive_multigrid_nonMPI</span>

<span class="kn">from</span> <span class="nn">pySDC.helpers.stats_helper</span> <span class="k">import</span> <span class="n">filter_stats</span><span class="p">,</span> <span class="n">sort_stats</span>
<span class="kn">import</span> <span class="nn">pySDC.helpers.plot_helper</span> <span class="k">as</span> <span class="nn">plt_helper</span>


<span class="k">def</span> <span class="nf">setup_parameters</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper routine to fill in all relevant parameters</span>

<span class="sd">    Note that this file will be used for all versions of SDC, containing more than necessary for each individual run</span>

<span class="sd">    Returns:</span>
<span class="sd">        description (dict)</span>
<span class="sd">        controller_params (dict)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialize level parameters</span>
    <span class="n">level_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;restol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-08</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">level_params</span><span class="p">[</span><span class="s1">&#39;nsweeps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># initialize sweeper parameters</span>
    <span class="n">sweeper_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;collocation_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CollGaussRadau_Right</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;Q1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LU&#39;</span><span class="p">]</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;Q2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LU&#39;</span><span class="p">]</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;QI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LU&#39;</span><span class="p">]</span>
    <span class="n">sweeper_params</span><span class="p">[</span><span class="s1">&#39;spread&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># initialize problem parameters</span>
    <span class="n">problem_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;Du&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;Dv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.09</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.086</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nvars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)]</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nlsol_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-10</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;nlsol_maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;lsol_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1E-10</span>
    <span class="n">problem_params</span><span class="p">[</span><span class="s1">&#39;lsol_maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="c1"># initialize step parameters</span>
    <span class="n">step_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">step_params</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>

    <span class="c1"># initialize space transfer parameters</span>
    <span class="c1"># space_transfer_params = dict()</span>
    <span class="c1"># space_transfer_params[&#39;finter&#39;] = True</span>

    <span class="c1"># initialize controller parameters</span>
    <span class="n">controller_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">controller_params</span><span class="p">[</span><span class="s1">&#39;logger_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="c1"># fill description dictionary for easy step instantiation</span>
    <span class="n">description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># pass problem class</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">problem_params</span>  <span class="c1"># pass problem parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">petsc_data</span>  <span class="c1"># pass data type for u</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># pass data type for f</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># pass sweeper (see part B)</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sweeper_params</span>  <span class="c1"># pass sweeper parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_params</span>  <span class="c1"># pass level parameters</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;step_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_params</span>  <span class="c1"># pass step parameters</span>
    <span class="c1"># description[&#39;space_transfer_class&#39;] = mesh_to_mesh_petsc_dmda  # pass spatial transfer class</span>
    <span class="c1"># description[&#39;space_transfer_params&#39;] = space_transfer_params  # pass paramters for spatial transfer</span>

    <span class="k">return</span> <span class="n">description</span><span class="p">,</span> <span class="n">controller_params</span>


<span class="k">def</span> <span class="nf">run_SDC_variant</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inexact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Routine to run particular SDC variant</span>

<span class="sd">    Args:</span>
<span class="sd">        variant (str): string describing the variant</span>
<span class="sd">        inexact (bool): flag to use inexact nonlinear solve (or nor)</span>
<span class="sd">        cwd (str): current working directory</span>

<span class="sd">    Returns:</span>
<span class="sd">        timing (float)</span>
<span class="sd">        niter (float)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># load (incomplete) default parameters</span>
    <span class="n">description</span><span class="p">,</span> <span class="n">controller_params</span> <span class="o">=</span> <span class="n">setup_parameters</span><span class="p">()</span>

    <span class="c1"># add stuff based on variant</span>
    <span class="k">if</span> <span class="n">variant</span> <span class="o">==</span> <span class="s1">&#39;fully-implicit&#39;</span><span class="p">:</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">petsc_grayscott_fullyimplicit</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">petsc_data</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generic_implicit</span>
    <span class="k">elif</span> <span class="n">variant</span> <span class="o">==</span> <span class="s1">&#39;semi-implicit&#39;</span><span class="p">:</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">petsc_grayscott_semiimplicit</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs_imex_petsc_data</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imex_1st_order</span>
    <span class="k">elif</span> <span class="n">variant</span> <span class="o">==</span> <span class="s1">&#39;multi-implicit&#39;</span><span class="p">:</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">petsc_grayscott_multiimplicit</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs_2comp_petsc_data</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multi_implicit</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="s1">&#39;Wrong variant specified, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">variant</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">inexact</span><span class="p">:</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">][</span><span class="s1">&#39;lsol_maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_params&#39;</span><span class="p">][</span><span class="s1">&#39;nlsol_maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Working on inexact </span><span class="si">%s</span><span class="s1"> variant...&#39;</span> <span class="o">%</span> <span class="n">variant</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Working on exact </span><span class="si">%s</span><span class="s1"> variant...&#39;</span> <span class="o">%</span> <span class="n">variant</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="c1"># set time parameters</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">Tend</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c1"># instantiate controller</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="n">allinclusive_multigrid_nonMPI</span><span class="p">(</span><span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">controller_params</span><span class="o">=</span><span class="n">controller_params</span><span class="p">,</span>
                                               <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

    <span class="c1"># get initial values on finest level</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">MS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span>
    <span class="n">uinit</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>

    <span class="c1"># call main function to get things done...</span>
    <span class="n">uend</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="n">uinit</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">Tend</span><span class="o">=</span><span class="n">Tend</span><span class="p">)</span>

    <span class="c1"># load reference solution to compare with</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">cwd</span> <span class="o">+</span> <span class="s1">&#39;data/GS_reference.dat&#39;</span>
    <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span><span class="o">.</span><span class="n">createBinary</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">uex</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>
    <span class="n">uex</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Vec</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">viewer</span><span class="p">)</span>
    <span class="n">err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">uex</span> <span class="o">-</span> <span class="n">uend</span><span class="p">)</span>

    <span class="c1"># filter statistics by variant (number of iterations)</span>
    <span class="n">filtered_stats</span> <span class="o">=</span> <span class="n">filter_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;niter&#39;</span><span class="p">)</span>

    <span class="c1"># convert filtered statistics to list of iterations count, sorted by process</span>
    <span class="n">iter_counts</span> <span class="o">=</span> <span class="n">sort_stats</span><span class="p">(</span><span class="n">filtered_stats</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="c1"># compute and print statistics</span>
    <span class="n">niters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iter_counts</span><span class="p">])</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Mean number of iterations: </span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Range of values for number of iterations: </span><span class="si">%2i</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Position of max/min number of iterations: </span><span class="si">%2i</span><span class="s1"> -- </span><span class="si">%2i</span><span class="s1">&#39;</span> <span class="o">%</span> \
          <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">niters</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">niters</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Std and var for number of iterations: </span><span class="si">%4.2f</span><span class="s1"> -- </span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">niters</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">niters</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Iteration count (nonlinear/linear): </span><span class="si">%i</span><span class="s1"> / </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">snes_itercount</span><span class="p">,</span> <span class="n">P</span><span class="o">.</span><span class="n">ksp_itercount</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean Iteration count per call: </span><span class="si">%4.2f</span><span class="s1"> / </span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">snes_itercount</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">snes_ncalls</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                            <span class="n">P</span><span class="o">.</span><span class="n">ksp_itercount</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">ksp_ncalls</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="n">timing</span> <span class="o">=</span> <span class="n">sort_stats</span><span class="p">(</span><span class="n">filter_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;timing_run&#39;</span><span class="p">),</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time to solution: </span><span class="si">%6.4f</span><span class="s1"> sec.&#39;</span> <span class="o">%</span> <span class="n">timing</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error vs. reference solution: </span><span class="si">%6.4e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mf">3E-06</span><span class="p">,</span> <span class="s1">&#39;ERROR: variant </span><span class="si">%s</span><span class="s1"> did not match error tolerance, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">variant</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;ERROR: number of iterations is too high, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">timing</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">show_results</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plotting routine</span>

<span class="sd">    Args:</span>
<span class="sd">        fname: file name to read in and name plots</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">plt_helper</span><span class="o">.</span><span class="n">mpl</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;classic&#39;</span><span class="p">)</span>
    <span class="n">plt_helper</span><span class="o">.</span><span class="n">setup_mpl</span><span class="p">()</span>

    <span class="n">plt_helper</span><span class="o">.</span><span class="n">newfig</span><span class="p">(</span><span class="n">textwidth</span><span class="o">=</span><span class="mf">238.96</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">xcoords</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))]</span>
    <span class="n">sorted_data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">results</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">heights</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sorted_data</span><span class="p">]</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sorted_data</span><span class="p">]</span>

    <span class="n">plt_helper</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">xcoords</span><span class="p">,</span> <span class="n">heights</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

    <span class="n">plt_helper</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xcoords</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">plt_helper</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;time (sec)&#39;</span><span class="p">)</span>

    <span class="c1"># save plot, beautify</span>
    <span class="n">plt_helper</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">),</span> <span class="s1">&#39;ERROR: plotting did not create PDF file&#39;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.pgf&#39;</span><span class="p">),</span> <span class="s1">&#39;ERROR: plotting did not create PGF file&#39;</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">),</span> <span class="s1">&#39;ERROR: plotting did not create PNG file&#39;</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">run_reference</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper routine to create a reference solution using very high order SDC and small time-steps</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">description</span><span class="p">,</span> <span class="n">controller_params</span> <span class="o">=</span> <span class="n">setup_parameters</span><span class="p">()</span>

    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;problem_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">petsc_grayscott_semiimplicit</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;dtype_f&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs_imex_petsc_data</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imex_1st_order</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;sweeper_params&#39;</span><span class="p">][</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">description</span><span class="p">[</span><span class="s1">&#39;level_params&#39;</span><span class="p">][</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="c1"># set time parameters</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">Tend</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c1"># instantiate controller</span>
    <span class="n">controller</span> <span class="o">=</span> <span class="n">allinclusive_multigrid_nonMPI</span><span class="p">(</span><span class="n">num_procs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">controller_params</span><span class="o">=</span><span class="n">controller_params</span><span class="p">,</span>
                                               <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span>

    <span class="c1"># get initial values on finest level</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">MS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">prob</span>
    <span class="n">uinit</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">u_exact</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span>

    <span class="c1"># call main function to get things done...</span>
    <span class="n">uend</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">u0</span><span class="o">=</span><span class="n">uinit</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">Tend</span><span class="o">=</span><span class="n">Tend</span><span class="p">)</span>

    <span class="c1"># filter statistics by variant (number of iterations)</span>
    <span class="n">filtered_stats</span> <span class="o">=</span> <span class="n">filter_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;niter&#39;</span><span class="p">)</span>

    <span class="c1"># convert filtered statistics to list of iterations count, sorted by process</span>
    <span class="n">iter_counts</span> <span class="o">=</span> <span class="n">sort_stats</span><span class="p">(</span><span class="n">filtered_stats</span><span class="p">,</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="c1"># compute and print statistics</span>
    <span class="n">niters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iter_counts</span><span class="p">])</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Mean number of iterations: </span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Range of values for number of iterations: </span><span class="si">%2i</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">niters</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Position of max/min number of iterations: </span><span class="si">%2i</span><span class="s1"> -- </span><span class="si">%2i</span><span class="s1">&#39;</span> <span class="o">%</span> \
          <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">niters</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">niters</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;   Std and var for number of iterations: </span><span class="si">%4.2f</span><span class="s1"> -- </span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">niters</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">niters</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Iteration count (nonlinear/linear): </span><span class="si">%i</span><span class="s1"> / </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">snes_itercount</span><span class="p">,</span> <span class="n">P</span><span class="o">.</span><span class="n">ksp_itercount</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean Iteration count per call: </span><span class="si">%4.2f</span><span class="s1"> / </span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">snes_itercount</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">snes_ncalls</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                            <span class="n">P</span><span class="o">.</span><span class="n">ksp_itercount</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">ksp_ncalls</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="n">timing</span> <span class="o">=</span> <span class="n">sort_stats</span><span class="p">(</span><span class="n">filter_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;timing_run&#39;</span><span class="p">),</span> <span class="n">sortby</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time to solution: </span><span class="si">%6.4f</span><span class="s1"> sec.&#39;</span> <span class="o">%</span> <span class="n">timing</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;data/GS_reference.dat&#39;</span>
    <span class="n">viewer</span> <span class="o">=</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span><span class="o">.</span><span class="n">createBinary</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">viewer</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">uend</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span> <span class="s1">&#39;ERROR: PETSc did not create file&#39;</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">cwd</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main driver</span>

<span class="sd">    Args:</span>
<span class="sd">        cwd (str): current working directory (need this for testing)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Loop over variants, exact and inexact solves</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fully-implicit&#39;</span><span class="p">,</span> <span class="s1">&#39;multi-implicit&#39;</span><span class="p">,</span> <span class="s1">&#39;semi-implicit&#39;</span><span class="p">]:</span>

        <span class="n">results</span><span class="p">[(</span><span class="n">variant</span><span class="p">,</span> <span class="s1">&#39;exact&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">run_SDC_variant</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="n">variant</span><span class="p">,</span> <span class="n">inexact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[(</span><span class="n">variant</span><span class="p">,</span> <span class="s1">&#39;inexact&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">run_SDC_variant</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="n">variant</span><span class="p">,</span> <span class="n">inexact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>

    <span class="c1"># dump result</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;data/timings_SDC_variants_GrayScott&#39;</span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">),</span> <span class="s1">&#39;ERROR: pickle did not create file&#39;</span>

    <span class="c1"># visualize</span>
    <span class="n">show_results</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># run_reference()</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Results:</p>
<a class="reference internal image-reference" href="../_images/timings_SDC_variants_GrayScott.png"><img alt="../_images/timings_SDC_variants_GrayScott.png" src="../_images/timings_SDC_variants_GrayScott.png" style="width: 292.0px; height: 234.0px;" /></a>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">What is the fastest SDC variant?</a><ul>
<li><a class="reference internal" href="#fisher-and-gray-scott-equations">Fisher and Gray-Scott equations</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Hamiltonian.html"
                        title="previous chapter">Second-order Problems</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../pySDC/core.html"
                        title="next chapter">core package</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/projects/SDC_showdown.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../pySDC/core.html" title="core package"
             >next</a> |</li>
        <li class="right" >
          <a href="Hamiltonian.html" title="Second-order Problems"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pySDC 2 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Robert Speck.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>